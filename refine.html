<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Music Preferences Visualizer (ECharts)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif; margin: 10px;
      background: #f0f0f0; color: #333;
    }
    h2 { text-align: center; }

    #charts { display: flex; flex-direction: column; align-items: center; }
    .chart-box { width: 300px; height: 300px; max-width: 90%; margin: 20px 0; }

    #controls {
      margin: 10px 0;
      text-align: center;
      display: flex;
      gap: 12px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    #sliders { width: 100%; max-width: 820px; margin: 0 auto; }

    #sliders .slider-row {
      margin: 6px 0;
      display: grid;
      grid-template-columns: 24px 1fr 1.6fr 60px;
      gap: 8px;
      align-items: center;
      background: #fff;
      padding: 8px 10px;
      border-radius: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }

    .slider-row.disabled { opacity: 0.45; }

    .dim-name-wrap {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
      min-width: 0;
    }

    .dim-name {
      text-align: right;
      font-size: 13px;
      line-height: 1.1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 360px;
    }

    /* Use a real button for mobile tap */
    .info-dot-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #f1f1f1;
      color: #444;
      font-size: 11px;
      border: 1px solid #e3e3e3;
      cursor: pointer;
      user-select: none;
      flex: 0 0 auto;
      padding: 0;
    }
    .info-dot-btn:active { transform: translateY(1px); }

    .slider-row input[type=range] { width: 100%; }

    .dim-value {
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: #222;
    }

    #year-controls { margin: 10px 0; text-align: center; }
    #year-controls select { margin: 0 5px; }

    #applyBtn {
      padding: 8px 16px;
      font-size: 16px;
      border-radius: 10px;
      border: 0;
      background: #222;
      color: #fff;
      cursor: pointer;
    }
    #applyBtn:active { transform: translateY(1px); }

    /* -----------------------------
       Modal for descriptions (mobile-friendly)
       ----------------------------- */
    #descOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 9999;
    }
    #descOverlay.show { display: flex; }

    #descSheet {
      width: min(720px, 100%);
      background: #fff;
      border-radius: 14px 14px 0 0;
      padding: 14px 16px 18px 16px;
      box-shadow: 0 -6px 18px rgba(0,0,0,0.12);
    }
    #descTitle {
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 6px 0;
    }
    #descText {
      font-size: 13.5px;
      line-height: 1.35;
      margin: 0 0 12px 0;
      color: #333;
    }
    #descCloseBtn {
      background: #222;
      color: #fff;
      border: 0;
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      width: 100%;
    }
  </style>
</head>
<body>
  <h2>ðŸŽµ Refine Your Music Profile</h2>

  <div id="charts">
    <div id="mainRadar" class="chart-box"></div>
    <div id="detailRadar" class="chart-box"></div>
  </div>

  <div id="controls">
    <label for="categorySelect"><strong>Category:</strong></label>
    <select id="categorySelect"></select>

    <label style="display:flex; align-items:center; gap:6px;">
      <input type="checkbox" id="categoryEnabledChk" checked />
      <strong>Use this category</strong>
    </label>
  </div>

  <div id="sliders"></div>

  <div id="year-controls">
    <label><strong>Year From:</strong>
      <select id="yearFrom"></select>
    </label>
    <label><strong>To:</strong>
      <select id="yearTo"></select>
    </label>
  </div>

  <div style="text-align:center;">
    <button id="applyBtn">âœ… Apply Changes</button>
  </div>

  <!-- Mobile-friendly description sheet -->
  <div id="descOverlay" role="dialog" aria-modal="true" aria-labelledby="descTitle">
    <div id="descSheet">
      <div id="descTitle"></div>
      <div id="descText"></div>
      <button id="descCloseBtn">Close</button>
    </div>
  </div>

  <script>
    (() => {
      const tg = window.Telegram.WebApp;
      tg.expand();

      // -----------------------------
      // 1) Parse initial vector + optional mask + year range from URL
      // -----------------------------
      const urlParams = new URLSearchParams(window.location.search);

      const vectorParam = urlParams.get('vector');
      let initialVector = [];
      if (vectorParam) {
        initialVector = vectorParam.split(',').map(x => {
          const val = parseInt(x, 10);
          return isNaN(val) ? 0 : val;
        });
      }
      while (initialVector.length < 58) initialVector.push(0);
      initialVector = initialVector.slice(0, 58);

      const maskParam = urlParams.get('mask');
      let activeMask = new Array(58).fill(true);
      if (maskParam) {
        const parsed = maskParam.split(',').map(x => {
          const t = String(x).trim().toLowerCase();
          return (t === '1' || t === 'true' || t === 'yes');
        });
        while (parsed.length < 58) parsed.push(true);
        activeMask = parsed.slice(0, 58);
      }

      const yearFromParam = urlParams.get('year_from');
      const yearToParam   = urlParams.get('year_to');

      // -----------------------------
      // 2) Dimension definitions (name + description)
      // -----------------------------
      const DIM_DEFS = [
        // VOCALS 1-7
        { name: "Vocal Register", desc: "Lead vocal range from low to high." },
        { name: "Vocal Timbre Thin/Full", desc: "Timbre from thin/wispy to full/resonant." },
        { name: "Vocal Breathiness", desc: "Airiness or breath in the vocal delivery." },
        { name: "Vocal Smoothness", desc: "Smooth, non-raspy vocal quality." },
        { name: "Vocal Grittiness", desc: "Rough/raspy or gritty vocal texture." },
        { name: "Vocal Nasality", desc: "Nasal, pinched, â€˜plugged-upâ€™ vocal tone." },
        { name: "Vocal Accompaniment", desc: "Importance of backing/secondary vocals (incl. layers/samples)." },

        // HARMONY 8-9
        { name: "Minor/Major Tonality", desc: "Whether the harmonic feel leans minor, major, or ambiguous." },
        { name: "Harmonic Sophistication", desc: "Harmony complexity from simple to more chromatic/advanced." },

        // RHYTHM 10-19
        { name: "Tempo", desc: "Perceived speed of the song." },
        { name: "Cut Time Feel", desc: "Half-time/cut-time rhythmic feel." },
        { name: "Triple Meter", desc: "Presence of 3-based meter (e.g., 3/4)." },
        { name: "Compound Meter", desc: "Compound feel combining triple + duple groupings." },
        { name: "Odd Meter", desc: "Presence of odd meters (5, 7, etc.)." },
        { name: "Swing Feel", desc: "Uneven 8th-note swing (long-short)." },
        { name: "Shuffle Feel", desc: "Stronger, more articulated swing/shuffle groove." },
        { name: "Syncopation", desc: "Offbeat emphasis, rhythmic surprise/complexity." },
        { name: "Backbeat", desc: "Emphasis on beats 2 and 4." },
        { name: "Danceability", desc: "How suitable the groove is for dancing." },

        // INSTRUMENTATION 20-35
        { name: "Drum Set", desc: "Presence/dominance of acoustic drum kit." },
        { name: "Drum Aggressiveness", desc: "Hard-hitting or intense drum performance." },
        { name: "Synthetic Drums", desc: "Programmed/electronic drum presence." },
        { name: "Percussion", desc: "Non-kit percussion prominence." },
        { name: "Electric Guitar", desc: "Presence/dominance of electric guitars." },
        { name: "Guitar Distortion", desc: "Amount of distortion from clean to dirty." },
        { name: "Acoustic Guitar", desc: "Presence/dominance of acoustic guitars." },
        { name: "String Ensemble", desc: "Presence of orchestral strings." },
        { name: "Horn Ensemble", desc: "Presence of brass/woodwind ensemble textures." },
        { name: "Piano", desc: "Presence/dominance of piano." },
        { name: "Organ", desc: "Presence/dominance of organ." },
        { name: "Rhodes", desc: "Presence of Fender Rhodes/electric piano." },
        { name: "Synthesizer", desc: "Presence/dominance of synths." },
        { name: "Synth Timbre", desc: "Synth character from ambient to robotic/industrial." },
        { name: "Bass Guitar", desc: "Presence/dominance of bass guitar." },
        { name: "Reed Instrument", desc: "Presence of reeds (sax, clarinet, etc.)." },

        // LYRICS 36-43
        { name: "Angry Lyrics", desc: "Anger/aggression in lyrical themes." },
        { name: "Sad Lyrics", desc: "Sadness/melancholy in lyrical themes." },
        { name: "Happy Lyrics", desc: "Joyful/positive lyrical themes." },
        { name: "Humorous Lyrics", desc: "Comedy, wit, playful lyricism." },
        { name: "Love Lyrics", desc: "Romance/love themes." },
        { name: "Political Lyrics", desc: "Social/political subject matter." },
        { name: "Abstract Lyrics", desc: "Surreal, abstract or whimsical lyricism." },
        { name: "Explicit Lyrics", desc: "Profanity/explicit content level." },

        // SONORITY 44-49
        { name: "Live Recording", desc: "Live vs studio capture feel." },
        { name: "Audio Production", desc: "Perceived polish/quality of production." },
        { name: "Aural Intensity", desc: "Overall loudness/softness and sonic force." },
        { name: "Acoustic Sonority", desc: "Acoustic instrumentation dominance." },
        { name: "Electric Sonority", desc: "Electric instrumentation dominance." },
        { name: "Synthetic Sonority", desc: "Electronic/synthetic texture dominance." },

        // COMPOSITION 50-58
        { name: "Focus Lead Vocal", desc: "How central the lead vocal is to the track." },
        { name: "Focus Lyrics", desc: "How central lyrical content is." },
        { name: "Focus Melody", desc: "How central melodic writing is." },
        { name: "Focus Vocal Acc.", desc: "Importance of backing vocals/layers." },
        { name: "Focus Groove", desc: "Importance of rhythmic feel/groove." },
        { name: "Focus Arrangement", desc: "Importance of orchestration/arrangement detail." },
        { name: "Focus Form", desc: "Importance of structure/sections." },
        { name: "Focus Riffs", desc: "Importance of repeating instrumental hooks/riffs." },
        { name: "Focus Performance", desc: "Importance of instrumental/performer energy/virtuosity." },
      ];

      while (DIM_DEFS.length < 58) DIM_DEFS.push({ name: "Unknown", desc: "No description available." });

      // -----------------------------
      // 3) Categories
      // -----------------------------
      const categories = [
        { name: "Vocals",          start: 0,  length: 7  },
        { name: "Harmony",         start: 7,  length: 2  },
        { name: "Rhythm",          start: 9,  length: 10 },
        { name: "Instrumentation", start: 19, length: 16 },
        { name: "Lyrics",          start: 35, length: 8  },
        { name: "Sonority",        start: 43, length: 6  },
        { name: "Composition",     start: 49, length: 9  },
      ];

      // -----------------------------
      // 4) Populate category select
      // -----------------------------
      const categorySelect = document.getElementById('categorySelect');
      categories.forEach((cat, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = cat.name;
        categorySelect.appendChild(opt);
      });
      categorySelect.value = "0";

      // -----------------------------
      // 5) Year dropdowns
      // -----------------------------
      const yearFromSel = document.getElementById('yearFrom');
      const yearToSel   = document.getElementById('yearTo');
      const minYear = 1900, maxYear = 2025;

      for (let y = minYear; y <= maxYear; y++) {
        const optF = document.createElement('option');
        optF.value = y; optF.textContent = y;
        yearFromSel.appendChild(optF);

        const optT = document.createElement('option');
        optT.value = y; optT.textContent = y;
        yearToSel.appendChild(optT);
      }
      yearFromSel.value = yearFromParam || minYear;
      yearToSel.value   = yearToParam   || maxYear;

      // -----------------------------
      // 6) Mask helpers
      // -----------------------------
      function categoryHasAnyEnabled(catIndex) {
        const cat = categories[catIndex];
        for (let j = 0; j < cat.length; j++) {
          if (activeMask[cat.start + j]) return true;
        }
        return false;
      }

      function setCategoryEnabled(catIndex, enabled) {
        const cat = categories[catIndex];
        for (let j = 0; j < cat.length; j++) {
          activeMask[cat.start + j] = enabled;
        }
      }

      function calcCategoryAverages(vec) {
        return categories.map((cat) => {
          let sum = 0;
          let count = 0;
          for (let j = 0; j < cat.length; j++) {
            const di = cat.start + j;
            if (!activeMask[di]) continue;
            let val = vec[di];
            if (isNaN(val)) val = 0;
            sum += val;
            count++;
          }
          if (count === 0) return 0;
          return Math.round(sum / count);
        });
      }

      // -----------------------------
      // 7) Charts
      // -----------------------------
      const mainChart   = echarts.init(document.getElementById('mainRadar'));
      const detailChart = echarts.init(document.getElementById('detailRadar'));

      function renderMainRadar() {
        const categoryData = calcCategoryAverages(initialVector);
        const mainOption = {
          tooltip: {},
          radar: {
            indicator: categories.map(cat => ({ name: cat.name, max: 100 })),
            radius: '70%'
          },
          series: [{
            name: 'Overall Profile',
            type: 'radar',
            data: [{ value: categoryData, name: 'Profile' }],
            areaStyle: { opacity: 0.2 },
            itemStyle: { color: '#884EA0' }
          }]
        };
        mainChart.setOption(mainOption, true);
      }

      function renderDetailRadar(catIndex) {
        const cat = categories[catIndex];
        const indicators = [];

        for (let j = 0; j < cat.length; j++) {
          const di = cat.start + j;
          indicators.push({ name: DIM_DEFS[di].name, max: 100 });
        }

        const values = [];
        for (let j = 0; j < cat.length; j++) {
          const di = cat.start + j;
          const v = isNaN(initialVector[di]) ? 0 : initialVector[di];
          values.push(activeMask[di] ? v : 0);
        }

        const detailOption = {
          tooltip: {},
          radar: { indicator: indicators, radius: '70%' },
          series: [{
            name: cat.name + " Details",
            type: 'radar',
            data: [{ value: values, name: cat.name }],
            areaStyle: { opacity: 0.2 },
            itemStyle: { color: '#36A2EB' }
          }]
        };
        detailChart.setOption(detailOption, true);
      }

      // -----------------------------
      // 8) Mobile-friendly description sheet
      // -----------------------------
      const descOverlay = document.getElementById('descOverlay');
      const descTitle   = document.getElementById('descTitle');
      const descText    = document.getElementById('descText');
      const descCloseBtn = document.getElementById('descCloseBtn');

      function openDesc(def) {
        descTitle.textContent = def.name;
        descText.textContent = def.desc;
        descOverlay.classList.add('show');
      }
      function closeDesc() {
        descOverlay.classList.remove('show');
      }
      descCloseBtn.addEventListener('click', closeDesc);
      descOverlay.addEventListener('click', (e) => {
        if (e.target === descOverlay) closeDesc();
      });

      // -----------------------------
      // 9) Sliders + toggles + descriptions
      // -----------------------------
      const categoryEnabledChk = document.getElementById('categoryEnabledChk');

      function syncCategoryCheckbox(catIndex) {
        categoryEnabledChk.checked = categoryHasAnyEnabled(catIndex);
      }

      function renderDetailCategory(catIndex) {
        const cat = categories[catIndex];

        syncCategoryCheckbox(catIndex);
        renderDetailRadar(catIndex);

        const slidersDiv = document.getElementById('sliders');
        slidersDiv.innerHTML = "";

        for (let j = 0; j < cat.length; j++) {
          const dimIndex = cat.start + j;
          const def = DIM_DEFS[dimIndex];

          const dimValue = isNaN(initialVector[dimIndex]) ? 0 : initialVector[dimIndex];
          const enabled  = !!activeMask[dimIndex];

          const row = document.createElement('div');
          row.className = 'slider-row' + (enabled ? '' : ' disabled');

          // Per-dim enable checkbox
          const useChk = document.createElement('input');
          useChk.type = 'checkbox';
          useChk.checked = enabled;
          useChk.title = "Include this dimension in similarity";

          // Name + info button
          const nameWrap = document.createElement('span');
          nameWrap.className = 'dim-name-wrap';

          const nameSpan = document.createElement('span');
          nameSpan.className = 'dim-name';
          nameSpan.textContent = def.name;

          const infoBtn = document.createElement('button');
          infoBtn.type = "button";
          infoBtn.className = 'info-dot-btn';
          infoBtn.textContent = "i";
          infoBtn.setAttribute("aria-label", `Info: ${def.name}`);
          infoBtn.addEventListener('click', () => openDesc(def));

          nameWrap.appendChild(nameSpan);
          nameWrap.appendChild(infoBtn);

          // Slider
          const slider = document.createElement('input');
          slider.type = 'range';
          slider.min = 0; slider.max = 100;
          slider.value = dimValue;
          slider.dataset.index = dimIndex;
          slider.disabled = !enabled;

          // Value display
          const valueSpan = document.createElement('span');
          valueSpan.className = 'dim-value';
          valueSpan.textContent = enabled ? dimValue : "Nan";

          slider.addEventListener('input', () => {
            const val = parseInt(slider.value, 10);
            const idx = parseInt(slider.dataset.index, 10);
            initialVector[idx] = isNaN(val) ? 0 : val;
            valueSpan.textContent = val;

            renderDetailRadar(catIndex);
            renderMainRadar();
          });

          useChk.addEventListener('change', () => {
            activeMask[dimIndex] = useChk.checked;
            slider.disabled = !useChk.checked;
            row.classList.toggle('disabled', !useChk.checked);
            valueSpan.textContent = useChk.checked ? slider.value : "Nan";

            syncCategoryCheckbox(catIndex);
            renderDetailRadar(catIndex);
            renderMainRadar();
          });

          row.appendChild(useChk);
          row.appendChild(nameWrap);
          row.appendChild(slider);
          row.appendChild(valueSpan);
          slidersDiv.appendChild(row);
        }

        // Category checkbox toggles all dims in the category
        categoryEnabledChk.onchange = () => {
          const enabled = categoryEnabledChk.checked;
          setCategoryEnabled(catIndex, enabled);
          renderDetailCategory(catIndex);
          renderMainRadar();
        };
      }

      // -----------------------------
      // 10) Initial render
      // -----------------------------
      renderMainRadar();
      renderDetailCategory(0);

      categorySelect.addEventListener('change', () => {
        const newIdx = parseInt(categorySelect.value, 10);
        renderDetailCategory(newIdx);
      });

      // -----------------------------
      // 11) Apply changes -> send vector + mask
      // -----------------------------
      document.getElementById('applyBtn').addEventListener('click', () => {
        const fromYear = parseInt(yearFromSel.value, 10);
        const toYear   = parseInt(yearToSel.value, 10);

        if (fromYear > toYear) {
          alert("The 'From Year' must be <= 'To Year'.");
          return;
        }

        const anyEnabled = activeMask.some(Boolean);
        if (!anyEnabled) {
          alert("You disabled all dimensions. Please enable at least one.");
          return;
        }

        const data = {
          vector: initialVector.map(x => Math.round(x)),
          mask: activeMask,
          year_from: fromYear,
          year_to: toYear
        };

        tg.sendData(JSON.stringify(data));
        tg.close();
      });

    })();
  </script>
</body>
</html>


